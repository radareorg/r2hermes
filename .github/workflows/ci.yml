name: CI

env:
  R2V: 6.0.7

on:
  push:
  workflow_dispatch: {}

jobs:
  build:
    name: Build library and r2 plugin
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.check_tag.outputs.tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install build deps
        run: sudo apt-get update -y && sudo apt-get install -y build-essential autoconf automake libtool pkg-config
      - name: Build library
        run: make
      - name: Downloading Radare2 Debian packages
        run: |
          wget -O r2.deb     https://github.com/radareorg/radare2/releases/download/${{env.R2V}}/radare2_${{env.R2V}}_amd64.deb
          wget -O r2-dev.deb https://github.com/radareorg/radare2/releases/download/${{env.R2V}}/radare2-dev_${{env.R2V}}_amd64.deb
      - name: Installing Radare2
        run: sudo dpkg -i r2.deb r2-dev.deb
      - name: Build r2 plugin
        run: make r2
      - name: Run testsuite
        run: make -C test
      - name: Check for tag on commit
        id: check_tag
        run: |
          set -eux
          TAG="$(git tag --points-at $GITHUB_SHA | head -n1 || true)"
          echo "found tag: '$TAG'"
          if [ -z "$TAG" ]; then
            echo "tag=" >> $GITHUB_OUTPUT
            exit 0
          fi
          if echo "$TAG" | grep -qE '^[0-9]'; then
            echo "tag=$TAG" >> $GITHUB_OUTPUT
          else
            echo "tag=" >> $GITHUB_OUTPUT
          fi

  release:
    name: Create release and upload tarball
    runs-on: ubuntu-latest
    needs: build
    if: needs.build.outputs.tag != ''

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create source tarball
        run: |
          TAG="${{ needs.build.outputs.tag }}"
          echo "Creating archive for $TAG"
          git archive --format=tar.gz --prefix=libhbc-$TAG/ $TAG -o libhbc-$TAG.tgz

      - name: Create GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.build.outputs.tag }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload release asset
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./libhbc-${{ needs.build.outputs.tag }}.tgz
          asset_name: libhbc-${{ needs.build.outputs.tag }}.tgz
          asset_content_type: application/gzip
