#ifndef HERMES_DEC_HERMES_OPCODES_H
#define HERMES_DEC_HERMES_OPCODES_H

#include "../common.h"
#include "../parsers/hbc_bytecode_parser.h"

/* Hermes opcodes based on hbc95.py (version 95) - Complete list */
enum HermesOpcodes {
	OP_Unreachable = 0,
	OP_NewObjectWithBuffer = 1,
	OP_NewObjectWithBufferLong = 2,
	OP_NewObject = 3,
	OP_NewObjectWithParent = 4,
	OP_NewArrayWithBuffer = 5,
	OP_NewArrayWithBufferLong = 6,
	OP_NewArray = 7,
	OP_Mov = 8,
	OP_MovLong = 9,
	OP_Negate = 10,
	OP_Not = 11,
	OP_BitNot = 12,
	OP_TypeOf = 13,
	OP_Eq = 14,
	OP_StrictEq = 15,
	OP_Neq = 16,
	OP_StrictNeq = 17,
	OP_Less = 18,
	OP_LessEq = 19,
	OP_Greater = 20,
	OP_GreaterEq = 21,
	OP_Add = 22,
	OP_AddN = 23,
	OP_Mul = 24,
	OP_MulN = 25,
	OP_Div = 26,
	OP_DivN = 27,
	OP_Mod = 28,
	OP_Sub = 29,
	OP_SubN = 30,
	OP_LShift = 31,
	OP_RShift = 32,
	OP_URshift = 33,
	OP_BitAnd = 34,
	OP_BitXor = 35,
	OP_BitOr = 36,
	OP_Inc = 37,
	OP_Dec = 38,
	OP_InstanceOf = 39,
	OP_IsIn = 40,
	OP_GetEnvironment = 41,
	OP_StoreToEnvironment = 42,
	OP_StoreToEnvironmentL = 43,
	OP_StoreNPToEnvironment = 44,
	OP_StoreNPToEnvironmentL = 45,
	OP_LoadFromEnvironment = 46,
	OP_LoadFromEnvironmentL = 47,
	OP_GetGlobalObject = 48,
	OP_GetNewTarget = 49,
	OP_CreateEnvironment = 50,
	OP_CreateInnerEnvironment = 51,
	OP_DeclareGlobalVar = 52,
	OP_ThrowIfHasRestrictedGlobalProperty = 53,
	OP_ThrowIfUndefinedInst = 206,
	OP_GetByIdShort = 54,
	OP_GetById = 55,
	OP_GetByIdLong = 56,
	OP_TryGetById = 57,
	OP_TryGetByIdLong = 58,
	OP_PutById = 59,
	OP_PutByIdLong = 60,
	OP_TryPutById = 61,
	OP_TryPutByIdLong = 62,
	OP_PutNewOwnByIdShort = 63,
	OP_PutNewOwnById = 64,
	OP_PutNewOwnByIdLong = 65,
	OP_PutNewOwnNEById = 66,
	OP_PutNewOwnNEByIdLong = 67,
	OP_PutOwnByIndex = 68,
	OP_PutOwnByIndexL = 69,
	OP_PutOwnByVal = 70,
	OP_DelById = 71,
	OP_DelByIdLong = 72,
	OP_GetByVal = 73,
	OP_PutByVal = 74,
	OP_DelByVal = 75,
	OP_PutOwnGetterSetterByVal = 76,
	OP_GetPNameList = 77,
	OP_GetNextPName = 78,
	OP_Call = 79,
	OP_Construct = 80,
	OP_Call1 = 81,
	OP_CallDirect = 82,
	OP_Call2 = 83,
	OP_Call3 = 84,
	OP_Call4 = 85,
	OP_CallLong = 86,
	OP_ConstructLong = 87,
	OP_CallDirectLongIndex = 88,
	OP_CallBuiltin = 89,
	OP_CallBuiltinLong = 90,
	OP_GetBuiltinClosure = 91,
	OP_Ret = 92,
	OP_Catch = 93,
	OP_DirectEval = 94,
	OP_Throw = 95,
	OP_ThrowIfEmpty = 96,
	OP_Debugger = 97,
	OP_DebuggerCheck = 207,
	OP_AsyncBreakCheck = 98,
	OP_ProfilePoint = 99,
	OP_CreateClosure = 100,
	OP_CreateClosureLongIndex = 101,
	OP_CreateGeneratorClosure = 102,
	OP_CreateGeneratorClosureLongIndex = 103,
	OP_CreateAsyncClosure = 104,
	OP_CreateAsyncClosureLongIndex = 105,
	OP_CreateThis = 106,
	OP_SelectObject = 107,
	OP_LoadParam = 108,
	OP_LoadParamLong = 109,
	OP_LoadConstUInt8 = 110,
	OP_LoadConstInt = 111,
	OP_LoadConstDouble = 112,
	OP_LoadConstBigInt = 113,
	OP_LoadConstBigIntLongIndex = 114,
	OP_LoadConstString = 115,
	OP_LoadConstStringLongIndex = 116,
	OP_LoadConstEmpty = 117,
	OP_LoadConstUndefined = 118,
	OP_LoadConstNull = 119,
	OP_LoadConstTrue = 120,
	OP_LoadConstFalse = 121,
	OP_LoadConstZero = 122,
	OP_CoerceThisNS = 123,
	OP_LoadThisNS = 124,
	OP_ToNumber = 125,
	OP_ToNumeric = 126,
	OP_ToInt32 = 127,
	OP_AddEmptyString = 128,
	OP_GetArgumentsPropByVal = 129,
	OP_GetArgumentsLength = 130,
	OP_ReifyArguments = 131,
	OP_CreateRegExp = 132,
	OP_SwitchImm = 133,
	OP_StartGenerator = 134,
	OP_ResumeGenerator = 135,
	OP_CompleteGenerator = 136,
	OP_CreateGenerator = 137,
	OP_CreateGeneratorLongIndex = 138,
	OP_IteratorBegin = 139,
	OP_IteratorNext = 140,
	OP_IteratorClose = 141,
	OP_Jmp = 142,
	OP_JmpLong = 143,
	OP_JmpTrue = 144,
	OP_JmpTrueLong = 145,
	OP_JmpFalse = 146,
	OP_JmpFalseLong = 147,
	OP_JmpUndefined = 148,
	OP_JmpUndefinedLong = 149,
	OP_SaveGenerator = 150,
	OP_SaveGeneratorLong = 151,
	OP_JLess = 152,
	OP_JLessLong = 153,
	OP_JNotLess = 154,
	OP_JNotLessLong = 155,
	OP_JLessN = 156,
	OP_JLessNLong = 157,
	OP_JNotLessN = 158,
	OP_JNotLessNLong = 159,
	OP_JLessEqual = 160,
	OP_JLessEqualLong = 161,
	OP_JNotLessEqual = 162,
	OP_JNotLessEqualLong = 163,
	OP_JLessEqualN = 164,
	OP_JLessEqualNLong = 165,
	OP_JNotLessEqualN = 166,
	OP_JNotLessEqualNLong = 167,
	OP_JGreater = 168,
	OP_JGreaterLong = 169,
	OP_JNotGreater = 170,
	OP_JNotGreaterLong = 171,
	OP_JGreaterN = 172,
	OP_JGreaterNLong = 173,
	OP_JNotGreaterN = 174,
	OP_JNotGreaterNLong = 175,
	OP_JGreaterEqual = 176,
	OP_JGreaterEqualLong = 177,
	OP_JNotGreaterEqual = 178,
	OP_JNotGreaterEqualLong = 179,
	OP_JGreaterEqualN = 180,
	OP_JGreaterEqualNLong = 181,
	OP_JNotGreaterEqualN = 182,
	OP_JNotGreaterEqualNLong = 183,
	OP_JEqual = 184,
	OP_JEqualLong = 185,
	OP_JNotEqual = 186,
	OP_JNotEqualLong = 187,
	OP_JStrictEqual = 188,
	OP_JStrictEqualLong = 189,
	OP_JStrictNotEqual = 190,
	OP_JStrictNotEqualLong = 191,
	OP_Add32 = 192,
	OP_Sub32 = 193,
	OP_Mul32 = 194,
	OP_Divi32 = 195,
	OP_Divu32 = 196,
	OP_Loadi8 = 197,
	OP_Loadu8 = 198,
	OP_Loadi16 = 199,
	OP_Loadu16 = 200,
	OP_Loadi32 = 201,
	OP_Loadu32 = 202,
	OP_Store8 = 203,
	OP_Store16 = 204,
	OP_Store32 = 205
};

typedef struct {
	u32 count;
	Instruction *instructions;
} HBCISA;

/* Public API for getting instruction set by version */
HBCISA hbc_isa_getv(int version);

/* Helper functions */
bool is_jump_instruction(u8 opcode);
bool is_call_instruction(u8 opcode);
bool is_arithmetic_instruction(u8 opcode);
bool is_bitwise_instruction(u8 opcode);
bool is_load_instruction(u8 opcode);
bool is_store_instruction(u8 opcode);
bool is_comparison_instruction(u8 opcode);

/* Version support functions */
HBCISA get_versioned_instruction_set(u32 bytecode_version);
bool is_instruction_supported_in_version(u8 opcode, u32 bytecode_version);
u32 get_best_supported_version(u32 detected_version);
void cleanup_instruction_sets(void);

#endif /* HERMES_DEC_HERMES_OPCODES_H */
